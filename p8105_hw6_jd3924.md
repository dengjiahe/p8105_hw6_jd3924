p8105_hw6_jd3924
================
Jiahe Deng
2022-12-01

``` r
library(tidyverse)
```

    ## ── Attaching packages ─────────────────────────────────────── tidyverse 1.3.2 ──
    ## ✔ ggplot2 3.3.6      ✔ purrr   0.3.5 
    ## ✔ tibble  3.1.8      ✔ dplyr   1.0.10
    ## ✔ tidyr   1.2.1      ✔ stringr 1.4.1 
    ## ✔ readr   2.1.3      ✔ forcats 0.5.2 
    ## ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
    ## ✖ dplyr::filter() masks stats::filter()
    ## ✖ dplyr::lag()    masks stats::lag()

``` r
library(dplyr)
library(readr)
library(mgcv)
```

    ## 载入需要的程辑包：nlme
    ## 
    ## 载入程辑包：'nlme'
    ## 
    ## The following object is masked from 'package:dplyr':
    ## 
    ##     collapse
    ## 
    ## This is mgcv 1.8-40. For overview type 'help("mgcv-package")'.

``` r
library(modelr)
```

Question2

``` r
homicides_data = 
  read_csv("homicide-data.csv") %>%
  mutate(
    city_state = str_c(city,state, sep = ","),
    victim_age = as.numeric(victim_age),
    resolved = ifelse(disposition %in% c("Closed without arrest","Open/No arrest"), "unsolved","solved")) %>%
  filter(victim_race %in% c("White", "Black"),
         city_state != "Tulsa,AL")
```

    ## Rows: 52179 Columns: 12
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## chr (9): uid, victim_last, victim_first, victim_race, victim_age, victim_sex...
    ## dbl (3): reported_date, lat, lon
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.

    ## Warning in mask$eval_all_mutate(quo): 强制改变过程中产生了NA

``` r
homicides_data
```

    ## # A tibble: 39,693 × 14
    ##    uid   repor…¹ victi…² victi…³ victi…⁴ victi…⁵ victi…⁶ city  state   lat   lon
    ##    <chr>   <dbl> <chr>   <chr>   <chr>     <dbl> <chr>   <chr> <chr> <dbl> <dbl>
    ##  1 Alb-…  2.01e7 SATTER… VIVIANA White        15 Female  Albu… NM     35.1 -107.
    ##  2 Alb-…  2.01e7 MULA    VIVIAN  White        72 Female  Albu… NM     35.1 -107.
    ##  3 Alb-…  2.01e7 BOOK    GERALD… White        91 Female  Albu… NM     35.2 -107.
    ##  4 Alb-…  2.01e7 MARTIN… GUSTAVO White        56 Male    Albu… NM     35.1 -107.
    ##  5 Alb-…  2.01e7 LUJAN   KEVIN   White        NA Male    Albu… NM     35.1 -107.
    ##  6 Alb-…  2.01e7 GRAY    STEFAN… White        43 Female  Albu… NM     35.1 -107.
    ##  7 Alb-…  2.01e7 DAVID   LARRY   White        52 Male    Albu… NM     NA     NA 
    ##  8 Alb-…  2.01e7 BRITO   ELIZAB… White        22 Female  Albu… NM     35.1 -107.
    ##  9 Alb-…  2.01e7 KING    TEVION  Black        15 Male    Albu… NM     35.1 -107.
    ## 10 Alb-…  2.01e7 BOYKIN  CEDRIC  Black        25 Male    Albu… NM     35.1 -107.
    ## # … with 39,683 more rows, 3 more variables: disposition <chr>,
    ## #   city_state <chr>, resolved <chr>, and abbreviated variable names
    ## #   ¹​reported_date, ²​victim_last, ³​victim_first, ⁴​victim_race, ⁵​victim_age,
    ## #   ⁶​victim_sex

``` r
baltimore_df = 
  homicides_data %>%
  filter(city_state == "Baltimore,MD")
baltimore_df
```

    ## # A tibble: 2,753 × 14
    ##    uid   repor…¹ victi…² victi…³ victi…⁴ victi…⁵ victi…⁶ city  state   lat   lon
    ##    <chr>   <dbl> <chr>   <chr>   <chr>     <dbl> <chr>   <chr> <chr> <dbl> <dbl>
    ##  1 Bal-…  2.01e7 NELSON  LEON    Black        17 Male    Balt… MD     39.3 -76.7
    ##  2 Bal-…  2.01e7 GOLF    EDDIE   Black        26 Male    Balt… MD     39.3 -76.7
    ##  3 Bal-…  2.01e7 MACKEN… THOMAS… Black        21 Male    Balt… MD     39.4 -76.6
    ##  4 Bal-…  2.01e7 CANUPP  EDWARD… White        61 Male    Balt… MD     39.2 -76.6
    ##  5 Bal-…  2.01e7 CUNNIN… MICHAEL Black        46 Male    Balt… MD     39.4 -76.6
    ##  6 Bal-…  2.01e7 ALSTON  RAY WI… Black        27 Male    Balt… MD     39.3 -76.6
    ##  7 Bal-…  2.01e7 HENDER… YULE A… Black        21 Male    Balt… MD     39.3 -76.6
    ##  8 Bal-…  2.01e7 MCDOWE… MARCU   Black        16 Male    Balt… MD     39.3 -76.6
    ##  9 Bal-…  2.01e7 GARDNER RODNEY… Black        21 Male    Balt… MD     39.3 -76.6
    ## 10 Bal-…  2.01e7 BURNET… NELSENE Black        44 Female  Balt… MD     39.3 -76.7
    ## # … with 2,743 more rows, 3 more variables: disposition <chr>,
    ## #   city_state <chr>, resolved <chr>, and abbreviated variable names
    ## #   ¹​reported_date, ²​victim_last, ³​victim_first, ⁴​victim_race, ⁵​victim_age,
    ## #   ⁶​victim_sex

``` r
fit_logistic = 
  baltimore_df %>% 
  mutate(resolved = as.factor(resolved)) %>%
  glm(resolved ~ victim_age + victim_race + victim_sex, data = ., family = binomial())

fit_logistic %>% 
  broom::tidy() %>% 
  mutate(OR = exp(estimate),
         lower = exp(estimate - 1.96 * std.error),
         upper = exp(estimate + 1.96 * std.error)) %>%
  knitr::kable(digits = 3)
```

| term             | estimate | std.error | statistic | p.value |    OR | lower | upper |
|:-----------------|---------:|----------:|----------:|--------:|------:|------:|------:|
| (Intercept)      |   -0.310 |     0.171 |    -1.810 |   0.070 | 0.733 | 0.524 | 1.026 |
| victim_age       |    0.007 |     0.003 |     2.024 |   0.043 | 1.007 | 1.000 | 1.013 |
| victim_raceWhite |   -0.842 |     0.175 |    -4.818 |   0.000 | 0.431 | 0.306 | 0.607 |
| victim_sexMale   |    0.854 |     0.138 |     6.184 |   0.000 | 2.350 | 1.793 | 3.081 |

``` r
glm_cities = 
  homicides_data %>%
  nest(data = -city_state) %>%
  mutate(
    models = map(data, ~glm(as.factor(resolved) ~ victim_age + victim_race + victim_sex, data = .x, family = binomial())),
  results = map(models, broom::tidy)) %>% 
  select(-data, -models) %>% 
  unnest(results)

glm_cities = 
  glm_cities %>% 
  mutate(OR = exp(estimate),
         lower = exp(estimate - 1.96 * std.error),
         upper = exp(estimate + 1.96 * std.error))
glm_cities
```

    ## # A tibble: 193 × 9
    ##    city_state     term   estimate std.e…¹ statis…² p.value      OR lower   upper
    ##    <chr>          <chr>     <dbl>   <dbl>    <dbl>   <dbl>   <dbl> <dbl>   <dbl>
    ##  1 Albuquerque,NM (Inte… -6.12e-1 6.32e-1 -9.69e-1 3.33e-1 5.42e-1 0.157   1.87 
    ##  2 Albuquerque,NM victi…  1.97e-2 9.09e-3  2.16e+0 3.04e-2 1.02e+0 1.00    1.04 
    ##  3 Albuquerque,NM victi… -4.12e-1 4.16e-1 -9.90e-1 3.22e-1 6.62e-1 0.293   1.50 
    ##  4 Albuquerque,NM victi… -5.70e-1 3.85e-1 -1.48e+0 1.39e-1 5.66e-1 0.266   1.20 
    ##  5 Albuquerque,NM victi…  1.46e+1 8.83e+2  1.65e-2 9.87e-1 2.12e+6 0     Inf    
    ##  6 Atlanta,GA     (Inte… -8.69e-1 2.42e-1 -3.60e+0 3.21e-4 4.19e-1 0.261   0.673
    ##  7 Atlanta,GA     victi…  1.16e-2 4.66e-3  2.50e+0 1.24e-2 1.01e+0 1.00    1.02 
    ##  8 Atlanta,GA     victi… -2.69e-1 2.84e-1 -9.45e-1 3.45e-1 7.64e-1 0.438   1.33 
    ##  9 Atlanta,GA     victi… -7.71e-5 1.94e-1 -3.97e-4 1.00e+0 1.00e+0 0.683   1.46 
    ## 10 Baltimore,MD   (Inte… -3.10e-1 1.71e-1 -1.81e+0 7.04e-2 7.33e-1 0.524   1.03 
    ## # … with 183 more rows, and abbreviated variable names ¹​std.error, ²​statistic
